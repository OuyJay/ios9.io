<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no">
    <title>ç”µè§†ç›´æ’­</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif;
            background: #f2f2f7;
            color: #1c1c1e;
            line-height: 1.4;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .header {
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            padding: 10px 16px;
            padding-top: max(10px, env(safe-area-inset-top));
            border-bottom: 0.5px solid rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 17px;
            font-weight: 600;
            text-align: center;
            margin: 0;
        }

        .player-container {
            width: 100%;
            background: #000;
            position: relative;
            margin-top: 44px;
        }

        .player-wrapper {
            position: relative;
            padding-top: 56.25%; /* 16:9 */
        }

        #videoPlayer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            object-fit: contain;
        }

        .channels-container {
            padding: 16px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 12px;
            padding-left: 4px;
        }

        .channel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }

        .channel-item {
            background: #fff;
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: all 0.2s;
        }

        .channel-item:active {
            transform: scale(0.96);
            background: #f2f2f7;
        }

        .channel-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .channel-name {
            font-size: 15px;
            font-weight: 500;
        }

        .custom-source {
            background: #fff;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .custom-source input {
            width: 100%;
            padding: 12px;
            border: 1px solid #e5e5ea;
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 15px;
        }

        .custom-source button {
            width: 100%;
            padding: 12px;
            background: #007aff;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
        }

        .status-toast {
            position: fixed;
            bottom: 32px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 20px;
            color: #fff;
            font-weight: 500;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .status-toast.show {
            opacity: 1;
        }

        .status-success { background: #34c759; }
        .status-error { background: #ff3b30; }
        .status-loading { background: #007aff; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ç”µè§†ç›´æ’­</h1>
    </div>

    <div class="player-container">
        <div class="player-wrapper">
            <video id="videoPlayer"
                   playsinline
                   webkit-playsinline
                   x-webkit-airplay="allow"
                   x5-video-player-type="h5"
                   x5-video-player-fullscreen="true"
                   x5-video-orientation="portraint"
                   preload="auto"
                   controls>
            </video>
        </div>
    </div>

    <div class="channels-container">
        <div class="section-title">å¤®è§†é¢‘é“</div>
        <div class="channel-grid">
            <div class="channel-item" onclick="playChannel('CCTV1')">
                <div class="channel-icon">ğŸ“º</div>
                <div class="channel-name">CCTV-1 ç»¼åˆ</div>
            </div>
            <div class="channel-item" onclick="playChannel('CCTV5')">
                <div class="channel-icon">âš½ï¸</div>
                <div class="channel-name">CCTV-5 ä½“è‚²</div>
            </div>
        </div>

        <div class="section-title">å«è§†é¢‘é“</div>
        <div class="channel-grid">
            <div class="channel-item" onclick="playChannel('HUNANTV')">
                <div class="channel-icon">ğŸ­</div>
                <div class="channel-name">æ¹–å—å«è§†</div>
            </div>
            <div class="channel-item" onclick="playChannel('DRAGONTV')">
                <div class="channel-icon">ğŸ‰</div>
                <div class="channel-name">ä¸œæ–¹å«è§†</div>
            </div>
        </div>

        <div class="section-title">æ¸¯æ¾³é¢‘é“</div>
        <div class="channel-grid">
            <div class="channel-item" onclick="playChannel('TVB')">
                <div class="channel-icon">ğŸ¬</div>
                <div class="channel-name">TVB</div>
            </div>
            <div class="channel-item" onclick="playChannel('J2')">
                <div class="channel-icon">ğŸŒŸ</div>
                <div class="channel-name">J2</div>
            </div>
        </div>

        <div class="custom-source">
            <div class="section-title">è‡ªå®šä¹‰æº</div>
            <input type="text" id="customUrl" placeholder="è¾“å…¥m3u8ç›´æ’­æºåœ°å€">
            <button onclick="playCustomSource()">æ’­æ”¾</button>
        </div>
    </div>

    <div id="statusToast" class="status-toast"></div>

    <script>
        const channels = {
            'CCTV1': [
                'https://demo.unified-streaming.com/k8s/features/stable/video/tears-of-steel/tears-of-steel.ism/tears-of-steel-audio_eng=64008-video_eng=401000.m3u8',
                'https://demo.unified-streaming.com/k8s/features/stable/video/tears-of-steel/tears-of-steel.ism/tears-of-steel-audio_eng=64008-video_eng=401000.m3u8'
            ],
            'CCTV5': [
                'https://node1.olelive.com:6443/live/CCTV5HD/hls.m3u8',
                'http://dbiptv.sn.chinamobile.com/PLTV/88888890/224/3221226395/index.m3u8'
            ],
            'TVB': [
                'http://23.237.10.66:16106',
                'http://23.237.10.66:16410'
            ],
            'J2': [
                'https://p2.weizan.cn/1646497941/269664979080385265/live.m3u8',
                'http://r.jdshipin.com/ndGgS'
            ],
            'HUNANTV': [
                'http://dbiptv.sn.chinamobile.com/PLTV/88888890/224/3221226211/index.m3u8'
            ],
            'DRAGONTV': [
                'http://dbiptv.sn.chinamobile.com/PLTV/88888890/224/3221226217/index.m3u8'
            ]
        };

        let currentChannel = '';
        let currentSourceIndex = 0;
        let retryCount = 0;
        const maxRetries = 3;

        const video = document.getElementById('videoPlayer');
        const toast = document.getElementById('statusToast');

        function showStatus(message, type) {
            toast.textContent = message;
            toast.className = 'status-toast show';
            toast.classList.add(`status-${type}`);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.className = 'status-toast';
                }, 300);
            }, 3000);
        }

        function playChannel(channelId) {
            if (!channels[channelId]) {
                showStatus('é¢‘é“ä¸å­˜åœ¨', 'error');
                return;
            }

            currentChannel = channelId;
            currentSourceIndex = 0;
            retryCount = 0;
            playCurrentSource();
        }

        function checkHLSSupport() {
            const hasNativeHLS = video.canPlayType('application/vnd.apple.mpegurl');
            return {
                supported: hasNativeHLS === 'maybe' || hasNativeHLS === 'probably',
                type: hasNativeHLS ? 'native' : 'none'
            };
        }

        function playCurrentSource() {
            const sources = channels[currentChannel];
            if (currentSourceIndex >= sources.length) {
                showStatus('æ‰€æœ‰çº¿è·¯å°è¯•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                return;
            }

            const url = sources[currentSourceIndex];
            if (!url.includes('.m3u8')) {
                showStatus('ä¸æ”¯æŒçš„ç›´æ’­æºæ ¼å¼ï¼Œä»…æ”¯æŒm3u8æ ¼å¼', 'error');
                handlePlayError(new Error('ä¸æ”¯æŒçš„æ ¼å¼'));
                return;
            }

            showStatus(`æ­£åœ¨åŠ è½½: ${currentChannel}`, 'loading');
            const hlsSupport = checkHLSSupport();

            try {
                if (hlsSupport.supported) {
                    video.src = url;
                    const playPromise = video.play();
                    if (playPromise !== undefined) {
                        playPromise
                            .then(() => {
                                showStatus(`æ­£åœ¨æ’­æ”¾: ${currentChannel}`, 'success');
                            })
                            .catch(error => {
                                console.error('æ’­æ”¾å¤±è´¥:', error);
                                if (error.name === 'NotSupportedError') {
                                    showStatus('è§†é¢‘ç¼–ç æ ¼å¼ä¸æ”¯æŒï¼Œè¯·å°è¯•å…¶ä»–çº¿è·¯', 'error');
                                } else if (error.name === 'NotAllowedError') {
                                    showStatus('æ’­æ”¾è¢«é˜»æ­¢ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®', 'error');
                                } else {
                                    handlePlayError(error);
                                }
                            });
                    }
                } else {
                    showStatus('å½“å‰è®¾å¤‡ä¸æ”¯æŒHLSç›´æ’­æµæ’­æ”¾ï¼Œè¯·ä½¿ç”¨Safariæµè§ˆå™¨', 'error');
                }
            } catch (error) {
                handlePlayError(error);
            }
        }

        function handlePlayError(error) {
            console.error('æ’­æ”¾é”™è¯¯:', error);
            retryCount++;

            if (retryCount < maxRetries) {
                showStatus(`æ’­æ”¾å¤±è´¥ï¼Œæ­£åœ¨é‡è¯• (${retryCount}/${maxRetries})`, 'loading');
                setTimeout(playCurrentSource, 1000);
            } else {
                retryCount = 0;
                currentSourceIndex++;
                if (currentSourceIndex < channels[currentChannel].length) {
                    showStatus('åˆ‡æ¢å¤‡ç”¨çº¿è·¯...', 'loading');
                    setTimeout(playCurrentSource, 1000);
                } else {
                    showStatus('è¯¥é¢‘é“æš‚æ—¶æ— æ³•æ’­æ”¾', 'error');
                }
            }
        }

        function playCustomSource() {
            const url = document.getElementById('customUrl').value.trim();
            if (!url) {
                showStatus('è¯·è¾“å…¥ç›´æ’­æºåœ°å€', 'error');
                return;
            }
            if (!url.includes('.m3u8')) {
                showStatus('iOS 9ä»…æ”¯æŒm3u8æ ¼å¼çš„HLSç›´æ’­æµ', 'error');
                return;
            }

            currentChannel = 'è‡ªå®šä¹‰æº';
            currentSourceIndex = 0;
            retryCount = 0;

            const hlsSupport = checkHLSSupport();
            if (!hlsSupport.supported) {
                showStatus('å½“å‰è®¾å¤‡ä¸æ”¯æŒHLSç›´æ’­æµæ’­æ”¾ï¼Œè¯·ä½¿ç”¨Safariæµè§ˆå™¨', 'error');
                return;
            }

            try {
                video.src = url;
                const playPromise = video.play();
                if (playPromise !== undefined) {
                    playPromise
                        .then(() => {
                            showStatus('æ­£åœ¨æ’­æ”¾è‡ªå®šä¹‰æº', 'success');
                        })
                        .catch(error => {
                            console.error('æ’­æ”¾å¤±è´¥:', error);
                            if (error.name === 'NotSupportedError') {
                                showStatus('è§†é¢‘ç¼–ç ä¸æ”¯æŒï¼Œè¯·ç¡®ä¿ä½¿ç”¨H.264+AACç¼–ç ', 'error');
                            } else if (error.name === 'NotAllowedError') {
                                showStatus('æ’­æ”¾è¢«é˜»æ­¢ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®', 'error');
                            } else {
                                showStatus('æ’­æ”¾å¤±è´¥: ' + error.message, 'error');
                            }
                        });
                }
            } catch (error) {
                showStatus('æ’­æ”¾å‡ºé”™: ' + error.message, 'error');
            }
        }

        // é”™è¯¯å¤„ç†
        video.addEventListener('error', (e) => {
            console.error('è§†é¢‘é”™è¯¯:', e.target.error);
            const mediaError = e.target.error;
            if (mediaError) {
                switch (mediaError.code) {
                    case MediaError.MEDIA_ERR_ABORTED:
                        handlePlayError(new Error('æ’­æ”¾è¢«ä¸­æ–­'));
                        break;
                    case MediaError.MEDIA_ERR_NETWORK:
                        handlePlayError(new Error('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥'));
                        break;
                    case MediaError.MEDIA_ERR_DECODE:
                        showStatus('è§†é¢‘è§£ç é”™è¯¯ï¼Œå½“å‰è®¾å¤‡å¯èƒ½ä¸æ”¯æŒè¯¥ç¼–ç æ ¼å¼', 'error');
                        break;
                    case MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED:
                        showStatus('ä¸æ”¯æŒçš„è§†é¢‘æ ¼å¼æˆ–ç›´æ’­æºæ— æ•ˆ', 'error');
                        break;
                    default:
                        handlePlayError(new Error('è§†é¢‘åŠ è½½å¤±è´¥'));
                }
            }
        });

        // è‡ªåŠ¨æ¢å¤æ’­æ”¾
        video.addEventListener('pause', () => {
            if (currentChannel) {
                setTimeout(() => {
                    video.play().catch(() => {});
                }, 1000);
            }
        });
    </script>
</body>
</html>
